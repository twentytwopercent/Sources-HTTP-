window.onload = function () {
    const devicePixelRatio = window.devicePixelRatio || 1;
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    canvas.width = 1340 * devicePixelRatio;
    canvas.height = 645 * devicePixelRatio;

    var keyPressed = "idle";
    var playerAttacking = false;

    function Sound(src) {
        this.sound = document.createElement("audio");
        this.sound.src = src;
        this.sound.setAttribute("preload", "auto");
        this.sound.setAttribute("controls", "none");
        this.sound.style.display = "none";
        document.body.appendChild(this.sound);

        this.play = function(){
            this.sound.play();
        }

        this.stop = function(){
            this.sound.pause();
        }
    }

    function Object(x, y, height, width, color, type) {
        this.x = x;
        this.y = y;

        this.vx = 0;
        this.vy = 0;

        this.height = height;
        this.width = width;

        this.color = color;

        if (type != "solid") {
            this.image = type;
        }

        this.draw = function () {
            if (type != "solid") {
                ctx.drawImage(
                    this.image,
                    this.x,
                    this.y,
                    this.width, this.height);
            } else {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }

            this.x += this.vx;
            this.y += this.vy;
        }
    }

    let ground = new Object(0, 400, 500, 1366, "#00cc00", document.getElementById("ground"));
    let player = new Object(100, 290, 110, 150, "#000000", document.getElementById("playeridle1"));

    let enemy = new Object(400, 290, 110, 150, "#f00000", document.getElementById("enemy"));

    var playerAnimations = {
        delay: 45,

        idleFrame: 1,
        idleInc: true,

        walkFrame: 1,
        walkInc: true,

        attackFrame: 1
    }

    var enemyAnimations = {
        explodeFrame: 1
    }

    setInterval(function () {
        if (!playerStartAttack) {
            
            if (keyPressed == "idle") {

                player.image = document.getElementById("playeridle" + playerAnimations.idleFrame);
            
                if (playerAnimations.idleInc) {
                    playerAnimations.idleFrame ++ ;
                } else {
                    playerAnimations.idleFrame -- ;
                }

                if (playerAnimations.idleFrame == 1) {
                    playerAnimations.idleInc = true;
                } else if (playerAnimations.idleFrame == 20) {
                    playerAnimations.idleInc = false;
                }
            } else if (keyPressed == "d" || keyPressed == "a") {

                player.image = document.getElementById("playerrun" + playerAnimations.walkFrame);
            
                if (playerAnimations.walkInc) {
                    playerAnimations.walkFrame ++ ;
                } else {
                    playerAnimations.walkFrame -- ;
                }

                if (playerAnimations.walkFrame == 1) {
                    playerAnimations.walkInc = true;
                } else if (playerAnimations.walkFrame == 13) {
                    playerAnimations.walkInc = false;
                }
            }
        }
    }, playerAnimations.delay);

    var enemySpeed = 1;
    var playerStartAttack = false;

    document.addEventListener("keydown", function (e) {
        keyPressed = e.key;

        if (keyPressed == "d") {
            player.vx = 5;
        }

        if (keyPressed == "a") {
            player.vx = -5;
        }

        if (keyPressed == "e") {

            playerAnimations.attackFrame = 1;
            playerStartAttack = true;

            tempInt = setInterval(function () {
                player.image = document.getElementById("playerattack" + playerAnimations.attackFrame);
                playerAnimations.attackFrame ++ ;

                if (playerAnimations.attackFrame == 10) {
                    playerAttacking = true;
                }
            }, 35);
            
            setTimeout(function () {
                clearInterval(tempInt);
                playerAttacking = false;
                playerStartAttack = false;
            }, 480);
        }
    });

    document.addEventListener("keyup", function (e) {
        keyPressed = "idle";

        player.vx = 0;
    });

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ground.draw();
        player.draw();
        
        if (enemy != null) {
           if (player.x > (enemy.x - enemy.width/2) && player.x < (enemy.x + enemy.width/2) && playerAttacking) {
            enemyAnimations.explodeFrame = 1;
            enemy.x = 1300;
            enemySpeed += 0.1 ;
           } else {
               enemy.draw();
           }

           if (player.x > (enemy.x - enemy.width/4) && player.x < (enemy.x + enemy.width/4) && !playerAttacking) {
                document.write();
                alert("You Died! Re-Open the file to restart!");
           }
        }

        if (enemy.x >= player.x) {
            enemy.x -= enemySpeed;
        } else {
            enemy.x += enemySpeed;
        }

        requestAnimationFrame(gameLoop);
    }
    gameLoop();
}

window.onresize = function () {
    document.write("<h1 style='font-size: 75px; font-family: monospace'>Hey, that's cheating! You cant resize the window!</h1>")
}

